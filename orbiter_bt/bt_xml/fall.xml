<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <Action ID="getNextAction" next_action="{next_action}" itemname="{itemname}" aruco_id="{arucoID}"/>
            <Switch3 case_1="Restocking" case_2="Retrieval" case_3="Wait" variable="{next_action}">
                <Fallback>
                    <SubTree ID="restocking_pipeline" item="{itemname}"
                                                      aruco="{arucoID}"/>
                    <Action ID="signalRestockingFinished" itemname="{itemname}"/>
                    <SetBlackboard output_key="itemname" value="" />
                    <SetBlackboard output_key="arucoID" value="" />
                    <SetBlackboard output_key="next_action" value="Wait" />
                </Fallback>
                <SubTree ID="retrieval_pipeline" item="{itemname}" aruco="{arucoID}"/>
                <AlwaysSuccess/>
                <AlwaysFailure/>
            </Switch3>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="restocking_pipeline">
        <Sequence>
            <Fallback>
                <Condition ID="checkAtGoal" nav_goal="-8.1511,8.7678"/>
                <Action ID="GoToPose" nav_goal="-8.1511,8.7678" yaw="180"/>
            </Fallback>
            <Sequence>
                <Action ID="moveHead" head_goal="search"/>
                <Action ID="moveHead" head_goal="box" name="move head to box"/>
                <SetBlackboard output_key="item" value="obj1"/>
                <SetBlackboard output_key="aruco" value="aruco1"/>
                <Action ID="getItemPose" itemname="{item}" name="get box pose" pose="{box_pose}" type="suc"/>
                <Action ID="getItemPose" itemname="{aruco}" name="get aruco pose" pose="{aruco_pose}" type="drop"/>
                <!-- <Action ID="NavFallback" type="aruco" pose="{aruco_pose}" fwd_dist="1.0"/> -->
            </Sequence>

            <Sequence>
                <Action ID="MoveArm_CuRobo" arm_goal="{box_pose}" traj_type="0"/>
                <Action ID="suctionCmd" cmd="1"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{box_pose}" traj_type="1"/>

                <Action ID="MoveArm_CuRobo" arm_goal="{box_pose}" traj_type="2"/>

                <Action ID="MoveArm_CuRobo" arm_goal="{aruco_pose}" traj_type="0"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{aruco_pose}" traj_type="3"/> 

                <Action ID="suctionCmd" cmd="0"/>
                
                <Action ID="MoveArm_CuRobo" arm_goal="{aruco_pose}" traj_type="4"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{aruco_pose}" traj_type="7"/>
            </Sequence>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="retrieval_pipeline">
        <Sequence>
            <Fallback>
                <Condition ID="checkAtGoal" nav_goal="-6.29472,5.16153"/>
                <Action ID="GoToPose" nav_goal="-6.29472,5.16153" yaw="-13"/>
            </Fallback>
            <Sequence>
                <Action ID="moveHead" head_goal="{aruco}"/>
                <Action ID="getItemPose" itemname="{item}" pose="{suction_pose}" type="suc"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{suction_pose}" traj_type="-1"/>
            </Sequence>
            <Sequence>
                <Action ID="MoveArm_CuRobo" arm_goal="{suction_pose}" traj_type="0"/>
                <Action ID="suctionCmd" cmd="1"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{suction_pose}" traj_type="3"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{suction_pose}" traj_type="4"/>
                <Action ID="MoveArm_CuRobo" arm_goal="{suction_pose}" traj_type="7"/>
            </Sequence>
            <Action ID="GoToPose" nav_goal="-8.1511,8.7678" yaw="180"/>
            <Action ID="suctionCmd" cmd="0"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <SubTree ID="restocking_pipeline">
            <input_port name="item"/>
            <input_port name="aruco"/>
        </SubTree>
        <SubTree ID="retrieval_pipeline">
            <input_port name="item"/>
            <input_port name="aruco"/>
        </SubTree>
        <Action ID="GoToPose">
            <inout_port name="nav_goal"/>
            <inout_port name="yaw"/>
        </Action>
        <Action ID="MoveArm_CuRobo">
            <inout_port name="arm_goal"/>
            <inout_port name="traj_type"/>
        </Action>
        <Action ID="getItemPose">
            <input_port name="itemname"/>
            <output_port name="pose"/>
            <input_port name="type"/>
        </Action>
        <Action ID="getNextAction">
            <output_port name="next_action"/>
            <output_port name="itemname"/>
            <output_port name="arucoID"/>
        </Action>
        <Action ID="moveHead">
            <inout_port name="head_goal"/>
        </Action>
        <SubTree ID="restocking_pipeline"/>
        <SubTree ID="retrieval_pipeline"/>
        <Action ID="signalRestockingFinished">
            <inout_port name="itemname"/>
        </Action>
        <Action ID="suctionCmd">
            <inout_port name="cmd"/>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>